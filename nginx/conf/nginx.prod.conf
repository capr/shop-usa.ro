worker_processes  12;
user www-data www-data;

error_log logs/error.log;

events {
	worker_connections 1024;
}

http {
	include mime.types;

	# this will stay off for a looong time.
	lua_code_cache off;

	# load Lua modules from ../www, ../.. (luapower) and the system-wide openresty install, in this order.
	lua_package_path '${prefix}../www/?.lua;${prefix}../../bin/linux64/lua/?.lua;${prefix}../../?.lua;/usr/local/openresty/lualib/?.lua';
	lua_package_cpath '${prefix}../../bin/linux64/clib/?.so;/usr/local/openresty/lualib/?.so';

	# redirect all http subdomain requests to https apex domain.
	# TODO: redirect https subdomain requests to apex domain too.
	server {
		server_name *.shop-usa.ro;
		return 301 https://shop-usa.ro$request_uri;
	}

	# redirect all http requests to https.
	server {
		listen      80;
		server_name shop-usa.ro;
		return      301 https://shop-usa.ro$request_uri;
	}

	server {
		listen 443 ssl;

		# compress all text data
		gzip on;
		gzip_min_length 1000;
		gzip_types text/plain;
		gzip_types application/json;
		gzip_types application/javascript;
		gzip_types text/css;

		# add secret keys used by Lua scripts
		include secrets.conf;

		# serve static files first and fallback to Lua scripts
		location / {
			root ../www;
			try_files $uri @lua;
		}

		# serve product images from a separate dir outside the source tree
		location /img {
			root ../www;
			try_files $uri @lua;
		}

		# hide all the source code
		location ~ \.(lua|lp)$ {
			default_type text/html;
			content_by_lua_file '../www/_ngx.lua';
		}

		# serve all dynamic content through a single Lua entry-point
		location @lua {
			default_type text/html;
			content_by_lua_file '../www/_ngx.lua';
		}

		# facebook proxy for authentication
		location /graph.facebook.com/ {
			proxy_pass https://graph.facebook.com/;
			proxy_method GET;
			proxy_pass_request_headers off;
			proxy_pass_request_body off;
			internal;
		}

		# google+ proxy for authentication
		location /content.googleapis.com/ {
			proxy_pass https://content.googleapis.com/;
			proxy_method GET;
			proxy_pass_request_headers off;
			proxy_pass_request_body off;
			internal;
		}

		# add the ssl cert, key and dhparm
		ssl_certificate_key ../ssl/ssl.key;
		ssl_certificate     ../ssl/ssl.crt;
		ssl_dhparam         ../ssl/dhparam.pem;

		# set a preferred list of cyphers
		ssl_prefer_server_ciphers on;
		# ssl_ciphers 'AES256+EECDH:AES256+EDH:!aNULL';
		ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:ECDHE-RSA-RC4-SHA:ECDHE-ECDSA-RC4-SHA:AES128:AES256:RC4-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK;

		# disable SSL, leave TLS
		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
		
		# speed up ssl by caching conn. params.
		# 10MB = ~40k sessions; session expires after 10min.
		ssl_session_cache shared:SSL:10m;
		ssl_session_timeout 10m;

		# enable OCSP stapling to speed up cert. revocation checks.
		ssl_stapling on;
		ssl_stapling_verify on;
		ssl_trusted_certificate ../ssl/trustchain.crt;
		resolver 8.8.4.4 8.8.8.8 valid=300s;
		resolver_timeout 10s;

		# enable HSTS to prevent ssl stripping (not really!), but only for a short time.
		# otherwise, if our cert expires, we won't be able to downgrade to http.
		add_header Strict-Transport-Security max-age=14400;
		
		# prevent displaying our urls in frames.
		add_header X-Frame-Options DENY;

		# prevent browsers from sniffing mime types away from content-type.
		add_header X-Content-Type-Options nosniff;
	}
}
